{% extends "proteomescout/base.html" %}

{% block content %}
<div style="padding: 20px;">
    <h2>Experiment Download Request</h2>

    {% if not current_user.is_authenticated %}
    <p>You must login to use this resource. <a class="nav-link" href="{{url_for('auth.login')}}" style="border: 1px solid; padding: 5px; display: inline-block;">Log in</a></p>
    {% endif %}
    <form id="downloadForm" action="" method="post" style="margin: 20px;">
        {{ form.hidden_tag() }}
        
        <p>
            {{ form.annotate.label }}<br>
            {{ form.annotate() }}<br>
            {% for error in form.annotate.errors %}
            <span style="color: red;">[{{ error }}]</span>
            {% endfor %}
        </p>
        <p>{{ form.submit() }}</p>
    </form>

    <!-- Flash messages at the bottom of the form -->
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div id="flashMessages">
          <ul class="flashes">
            {% for message in messages %}
              <li>{{ message }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    {% endwith %}

    <!-- Flash messages at the bottom of the form -->
    <div id="flashMessages"></div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
    $(document).ready(function() {
        $('#downloadForm').on('submit', function(e) {
            e.preventDefault();
            $(this).find(':submit').attr('disabled', 'disabled');

            const formData = $(this).serialize();
            // console.log('Form data:', formData);  // log the form data to the console

            $.ajax({
                url: $(this).attr('action'),
                type: $(this).attr('method'),
                data: formData,
                success: function(data) {
                    console.log('AJAX request successful');  // log a success message
                    console.log('Server response:', data);  // log the server response
                    $('#flashMessages').html('<ul class="flashes"><li>' + data.message + '</li></ul>');
                },
                error: function(jqXHR, textStatus, errorThrown) {
                  //  console.log('Error:', errorThrown);
                  //  console.log('Server response:', jqXHR.responseText);
                    alert('An error occurred: ' + errorThrown);
                },
                complete: function() {
                    $('#downloadForm').find(':submit').removeAttr('disabled');
                }
            });
        });
    });
    </script>
</div>
{% endblock %}